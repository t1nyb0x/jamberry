# jamberry ユースケース

## 概要

本ドキュメントは、jamberry Discord Bot の主要なユースケースを定義します。

---

## アクター

| アクター       | 説明                                                 |
| -------------- | ---------------------------------------------------- |
| ユーザー       | Discord サーバー上で jamberry を利用する一般ユーザー |
| jamberry       | Discord Bot（本システム）                            |
| tracktaste API | Spotify 情報を提供するバックエンド REST API          |
| Discord API    | Discord プラットフォームの API                       |

---

## ユースケース一覧

| ID     | ユースケース名               | 概要                                        |
| ------ | ---------------------------- | ------------------------------------------- |
| UC-001 | トラック情報を取得する       | Spotify トラック URL から詳細情報を表示     |
| UC-002 | レコメンドを取得する         | トラックに基づくおすすめ楽曲を表示          |
| UC-003 | アーティスト情報を取得する   | Spotify アーティスト URL から詳細情報を表示 |
| UC-004 | アルバム情報を取得する       | Spotify アルバム URL から詳細情報を表示     |
| UC-005 | トラックを検索する           | キーワードで Spotify トラックを検索         |
| UC-006 | ページングで結果を閲覧する   | レコメンド・検索結果をページ送りで閲覧      |
| UC-007 | 他ユーザーの結果を自分で見る | 他ユーザーが実行した結果を自分専用で閲覧    |

---

## UC-001: トラック情報を取得する

### 基本情報

| 項目     | 内容                                      |
| -------- | ----------------------------------------- |
| アクター | ユーザー                                  |
| 事前条件 | ユーザーが Discord サーバーに参加している |
| 事後条件 | トラック情報が Embed 形式で表示される     |
| トリガー | ユーザーが `/track <url>` コマンドを実行  |

### 基本フロー

```
1. ユーザーが `/track <url>` コマンドを実行する
2. jamberry が入力をバリデーションする
3. jamberry が Discord に「処理中」表示を返す（DeferReply）
4. jamberry が入力を Spotify URL に正規化する
5. jamberry が tracktaste API にリクエストを送信する
6. tracktaste API がトラック情報を返す
7. jamberry が Embed を構築する
8. jamberry が Discord に結果を表示する
```

### 代替フロー

#### 2a. 入力バリデーションエラー

```
2a-1. 入力が無効な URL/ID の場合
2a-2. jamberry が Ephemeral でエラーメッセージを表示する
      「❌ Spotify の URL / ID として認識できませんでした。」
2a-3. ユースケース終了
```

#### 2b. エンティティ種別不一致

```
2b-1. URL が track 以外（artist/album）の場合
2b-2. jamberry が Ephemeral でエラーメッセージを表示する
      「❌ Spotify の TrackURL を入力してください」
2b-3. ユースケース終了
```

#### 6a. tracktaste API エラー

```
6a-1. tracktaste API が 4xx/5xx エラーを返す
6a-2. jamberry がエラーコードに応じたメッセージを表示する
6a-3. ユースケース終了
```

#### 6b. タイムアウト

```
6b-1. tracktaste API への接続が 5 秒以内に完了しない
6b-2. jamberry が通常メッセージでタイムアウトエラーを表示する
      「❌ リクエストがタイムアウトしました。しばらくしてから再試行してください。」
6b-3. ユースケース終了
```

### 入力例

| 入力形式    | 例                                   |
| ----------- | ------------------------------------ |
| Spotify URL | `https://open.spotify.com/track/xxx` |
| Spotify URI | `spotify:track:xxx`                  |
| 生 ID       | `4iV5W9uYEdYUVa79Axb7Rh`             |

---

## UC-002: レコメンドを取得する

### 基本情報

| 項目     | 内容                                                |
| -------- | --------------------------------------------------- |
| アクター | ユーザー                                            |
| 事前条件 | ユーザーが Discord サーバーに参加している           |
| 事後条件 | レコメンド結果が Embed 形式で表示される（5 件ずつ） |
| トリガー | ユーザーが `/recommend <url>` コマンドを実行        |

### 基本フロー

```
1. ユーザーが `/recommend <url>` コマンドを実行する
2. jamberry が入力をバリデーションする
3. jamberry が Discord に「処理中」表示を返す（DeferReply）
4. jamberry が入力を Spotify URL に正規化する
5. jamberry が tracktaste API にリクエストを送信する
6. tracktaste API が類似トラック情報を返す（最大30件）
7. jamberry が結果をキャッシュに保存する（L1 + L2）
8. jamberry が先頭 5 件を含む Embed を構築する
9. jamberry がページングボタン付きで Discord に結果を表示する
```

### 代替フロー

#### 2a. 入力バリデーションエラー

```
2a-1. 入力が無効な URL/ID の場合
2a-2. jamberry が Ephemeral でエラーメッセージを表示する
2a-3. ユースケース終了
```

#### 6a. 結果が 0 件

```
6a-1. tracktaste API が空の結果を返す
6a-2. jamberry が「該当する結果は見つかりませんでした」と表示する
6a-3. ユースケース終了
```

---

## UC-003: アーティスト情報を取得する

### 基本情報

| 項目     | 内容                                      |
| -------- | ----------------------------------------- |
| アクター | ユーザー                                  |
| 事前条件 | ユーザーが Discord サーバーに参加している |
| 事後条件 | アーティスト情報が Embed 形式で表示される |
| トリガー | ユーザーが `/artist <url>` コマンドを実行 |

### 基本フロー

```
1. ユーザーが `/artist <url>` コマンドを実行する
2. jamberry が入力をバリデーションする
3. jamberry が Discord に「処理中」表示を返す（DeferReply）
4. jamberry が入力を Spotify URL に正規化する
5. jamberry が tracktaste API にリクエストを送信する
6. tracktaste API がアーティスト情報を返す
7. jamberry が Embed を構築する
8. jamberry が Discord に結果を表示する
```

### 代替フロー

#### 2b. エンティティ種別不一致

```
2b-1. URL が artist 以外（track/album）の場合
2b-2. jamberry が Ephemeral でエラーメッセージを表示する
      「❌ Spotify の ArtistURL を入力してください」
2b-3. ユースケース終了
```

---

## UC-004: アルバム情報を取得する

### 基本情報

| 項目     | 内容                                      |
| -------- | ----------------------------------------- |
| アクター | ユーザー                                  |
| 事前条件 | ユーザーが Discord サーバーに参加している |
| 事後条件 | アルバム情報が Embed 形式で表示される     |
| トリガー | ユーザーが `/album <url>` コマンドを実行  |

### 基本フロー

```
1. ユーザーが `/album <url>` コマンドを実行する
2. jamberry が入力をバリデーションする
3. jamberry が Discord に「処理中」表示を返す（DeferReply）
4. jamberry が入力を Spotify URL に正規化する
5. jamberry が tracktaste API にリクエストを送信する
6. tracktaste API がアルバム情報を返す
7. jamberry が Embed を構築する（収録曲は先頭5曲）
8. jamberry が Discord に結果を表示する
```

### 代替フロー

#### 2b. エンティティ種別不一致

```
2b-1. URL が album 以外（track/artist）の場合
2b-2. jamberry が Ephemeral でエラーメッセージを表示する
      「❌ Spotify の AlbumURL を入力してください」
2b-3. ユースケース終了
```

---

## UC-005: トラックを検索する

### 基本情報

| 項目     | 内容                                          |
| -------- | --------------------------------------------- |
| アクター | ユーザー                                      |
| 事前条件 | ユーザーが Discord サーバーに参加している     |
| 事後条件 | 検索結果が Embed 形式で表示される（5 件ずつ） |
| トリガー | ユーザーが `/search <query>` コマンドを実行   |

### 基本フロー

```
1. ユーザーが `/search <query>` コマンドを実行する
2. jamberry が入力をバリデーションする（空でないか）
3. jamberry が Discord に「処理中」表示を返す（DeferReply）
4. jamberry が tracktaste API にリクエストを送信する
5. tracktaste API が検索結果を返す
6. jamberry が結果をキャッシュに保存する（L1 + L2）
7. jamberry が先頭 5 件を含む Embed を構築する
8. jamberry がページングボタン付きで Discord に結果を表示する
```

### 代替フロー

#### 2a. 検索クエリが空

```
2a-1. 検索クエリが空の場合
2a-2. jamberry が Ephemeral でエラーメッセージを表示する
      「❌ 検索キーワードを入力してください」
2a-3. ユースケース終了
```

#### 5a. 結果が 0 件

```
5a-1. tracktaste API が空の結果を返す
5a-2. jamberry が「🔍 該当する結果は見つかりませんでした。」と表示する
5a-3. ユースケース終了
```

---

## UC-006: ページングで結果を閲覧する

### 基本情報

| 項目     | 内容                                                 |
| -------- | ---------------------------------------------------- |
| アクター | ユーザー（コマンド実行者）                           |
| 事前条件 | `/recommend` または `/search` の結果が表示されている |
| 事後条件 | 次/前の 5 件が表示される                             |
| トリガー | ユーザーが「◀ 前へ」または「次へ ▶」ボタンを押す     |

### 基本フロー

```
1. ユーザーがページングボタンを押す
2. jamberry がボタンを押したユーザーを検証する
3. jamberry がキャッシュからデータを取得する（L1 → L2）
4. jamberry が該当ページのデータで Embed を更新する
5. jamberry がボタンの有効/無効状態を更新する
```

### 代替フロー

#### 2a. 操作権限なし

```
2a-1. ボタンを押したユーザーがコマンド実行者ではない場合
2a-2. jamberry が Ephemeral でメッセージを表示する
      「この操作はコマンド実行者のみが使用できます。
       『👁 自分も見る』ボタンを押すと、あなた専用の表示ができます。」
2a-3. ユースケース終了
```

#### 3a. キャッシュミス（L1）

```
3a-1. L1 キャッシュにデータがない
3a-2. jamberry が L2（Redis）からデータを取得する
3a-3. jamberry が L1 にデータを書き戻す
3a-4. 基本フロー 4 へ続く
```

#### 3b. キャッシュミス（L1 + L2）

```
3b-1. L1 にも L2 にもデータがない（期限切れ）
3b-2. jamberry が Ephemeral でエラーメッセージを表示する
      「データの有効期限が切れました。再度コマンドを実行してください。」
3b-3. ユースケース終了
```

#### 5a. 最初のページで「前へ」

```
5a-1. 現在が最初のページの場合
5a-2.「◀ 前へ」ボタンは無効化されているため操作不可
```

#### 5b. 最後のページで「次へ」

```
5b-1. 現在が最後のページの場合
5b-2.「次へ ▶」ボタンは無効化されているため操作不可
```

---

## UC-007: 他ユーザーの結果を自分で見る

### 基本情報

| 項目     | 内容                                                            |
| -------- | --------------------------------------------------------------- |
| アクター | ユーザー（コマンド実行者以外）                                  |
| 事前条件 | 他ユーザーの `/recommend` または `/search` 結果が表示されている |
| 事後条件 | 自分専用の Ephemeral Embed が表示される                         |
| トリガー | ユーザーが「👁 自分も見る」ボタンを押す                          |

### 基本フロー

```
1. ユーザーが「👁 自分も見る」ボタンを押す
2. jamberry がキャッシュからデータを取得する
3. jamberry が Ephemeral で Embed を構築する
4. jamberry がページングボタン付きで Ephemeral メッセージを表示する
5. ユーザーが自分専用のページングボタンで操作する
```

### 代替フロー

#### 2a. キャッシュミス

```
2a-1. キャッシュにデータがない（期限切れ）
2a-2. jamberry が Ephemeral でエラーメッセージを表示する
      「データの有効期限が切れました。再度コマンドを実行してください。」
2a-3. ユースケース終了
```

### 補足

- Ephemeral メッセージ内のページングは、そのユーザー専用となる
- 元のメッセージの状態には影響しない
- コマンド実行者も「👁 自分も見る」ボタンを使用可能

---

## 横断的ユースケース

### レートリミット

#### アプリケーションレベルのレートリミット

```
事前条件: ユーザーが 10 秒間に 5 回以上コマンドを実行
フロー:
1. ユーザーがコマンドを実行する
2. jamberry がレート制限を検出する
3. jamberry が Ephemeral でメッセージを表示する
   「⏳ 少し待ってから再試行してください。」
4. ユースケース終了
```

#### tracktaste レートリミット

```
事前条件: tracktaste API が 429 を返す
フロー:
1. tracktaste API が 429 エラーを返す
2. jamberry が通常メッセージでエラーを表示する
   「⏳ リクエスト制限中です。しばらくしてから再試行してください。」
3. ユースケース終了
```

---

## シーケンス図

### UC-001: トラック情報取得（正常系）

```
┌────────┐     ┌──────────┐     ┌───────────┐     ┌───────────────┐
│ ユーザー │     │ Discord  │     │ jamberry  │     │ tracktaste API│
└───┬────┘     └────┬─────┘     └─────┬─────┘     └───────┬───────┘
    │               │                 │                   │
    │ /track <url>  │                 │                   │
    │──────────────▶│                 │                   │
    │               │  Interaction    │                   │
    │               │────────────────▶│                   │
    │               │                 │                   │
    │               │  DeferReply     │                   │
    │               │◀────────────────│                   │
    │               │                 │                   │
    │  処理中...    │                 │ GET /v1/track/fetch
    │◀──────────────│                 │──────────────────▶│
    │               │                 │                   │
    │               │                 │   Track Data      │
    │               │                 │◀──────────────────│
    │               │                 │                   │
    │               │ EditResponse    │                   │
    │               │◀────────────────│                   │
    │               │                 │                   │
    │   Embed表示   │                 │                   │
    │◀──────────────│                 │                   │
    │               │                 │                   │
```

### UC-006: ページング（正常系）

```
┌────────┐     ┌──────────┐     ┌───────────┐     ┌───────┐
│ ユーザー │     │ Discord  │     │ jamberry  │     │ Cache │
└───┬────┘     └────┬─────┘     └─────┬─────┘     └───┬───┘
    │               │                 │               │
    │ 「次へ ▶」押下 │                 │               │
    │──────────────▶│                 │               │
    │               │  Interaction    │               │
    │               │────────────────▶│               │
    │               │                 │               │
    │               │                 │ Get(msg_id)   │
    │               │                 │──────────────▶│
    │               │                 │               │
    │               │                 │   Data        │
    │               │                 │◀──────────────│
    │               │                 │               │
    │               │ UpdateMessage   │               │
    │               │◀────────────────│               │
    │               │                 │               │
    │   更新Embed   │                 │               │
    │◀──────────────│                 │               │
    │               │                 │               │
```

---

## 非機能要件関連ユースケース

### Graceful Shutdown

```
事前条件: jamberry が稼働中
トリガー: SIGINT または SIGTERM を受信
フロー:
1. jamberry がシグナルを受信する
2. jamberry が新規リクエストの受付を停止する
3. jamberry が処理中のリクエストの完了を待つ
4. jamberry が Discord セッションを Close する
5. jamberry がプロセスを終了する
```

### Redis 接続エラー

```
事前条件: Redis への接続が失敗
フロー:
1. jamberry が Redis への接続を試みる
2. 接続エラーが発生する
3. jamberry が WARN ログを出力する
4. jamberry が L1（インメモリ）キャッシュのみで動作を継続する
```
