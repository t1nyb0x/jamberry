# jamberry 仕様書

## 概要

jamberry は、Spotify 関連の情報を Discord 上で取得できる Discord Bot です。

## 技術スタック

- **言語**: Go
- **Discord ライブラリ**: [discordgo](https://github.com/bwmarrin/discordgo)
- **バックエンド API**: [tracktaste (REST API)](https://github.com/t1nyb0x/tracktaste)

---

## 共通仕様

### レスポンス形式

| 項目           | 仕様                                   |
| -------------- | -------------------------------------- |
| メッセージ形式 | Embed 形式を使用                       |
| 可視性         | 通常メッセージ（チャンネル全体に表示） |

### エラーメッセージの可視性

エラーの種類によって可視性を分ける:

| エラー種別                                                | 可視性                                  |
| --------------------------------------------------------- | --------------------------------------- |
| 入力バリデーションエラー（無効な URL/ID、種別不一致など） | Ephemeral（呼び出しユーザーにのみ表示） |
| アプリケーションレベルのレートリミット                    | Ephemeral（呼び出しユーザーにのみ表示） |
| tracktaste 由来のエラー（4xx/5xx/タイムアウト）           | 通常メッセージ（チャンネル全体に表示）  |

### Discord 3 秒ルール対応

Discord のスラッシュコマンドは 3 秒以内に応答が必要なため、以下の方式を採用:

#### 入力バリデーションエラーの場合（即時判定可能）

1. コマンド受信
2. 入力をバリデーション
3. エラーがあれば `DeferReply()` を行わず、即座に Ephemeral で返信

#### tracktaste 呼び出しが必要な場合

1. コマンド受信 → 即座に `interaction.DeferReply()` を実行（処理中表示、通常メッセージ）
2. 裏で tracktaste API を呼び出し（タイムアウト 5 秒）
3. 結果が揃ったら `EditOriginalInteractionResponse` で返信
   - 成功時: Embed で結果を表示
   - エラー時: エラーメッセージを表示（通常メッセージとしてチャンネル全体に表示）

### フォーマット

| 項目       | フォーマット                   |
| ---------- | ------------------------------ |
| 再生時間   | `M:SS` (例: `3:45`)            |
| リリース日 | 下記「リリース日の精度」を参照 |
| 数値       | カンマ区切り (例: `1,234,567`) |

#### リリース日の精度

Spotify の `release_date` は精度が異なる場合がある（`YYYY` / `YYYY-MM` / `YYYY-MM-DD`）。  
jamberry では、**tracktaste から返された文字列をそのまま表示する**（無理にパースや補完を行わない）。

例:

- `2024` → `2024` と表示
- `2024-01` → `2024-01` と表示
- `2024-01-15` → `2024-01-15` と表示

### 権限

- 全コマンドはデフォルトで誰でも利用可能
- ギルド管理者限定コマンドは現時点では不要
- NSFW チャンネル制限は不要

### Bot に必要な Discord 権限

jamberry が正常に動作するために必要な最低限の権限:

| 権限               | 用途                           |
| ------------------ | ------------------------------ |
| Send Messages      | メッセージ送信                 |
| Embed Links        | Embed 形式でのメッセージ表示   |
| Use Slash Commands | スラッシュコマンドの登録・実行 |

OAuth2 スコープ:

- `bot`
- `applications.commands`

### 入力形式

全コマンドで以下の入力形式をサポート:

- Spotify URL: `https://open.spotify.com/track/xxx`
- Spotify URI: `spotify:track:xxx`
- 生 ID: `xxx`

#### 正規化ポリシー

jamberry 側で入力を正規化してから tracktaste に渡す:

| コマンド         | 正規化方式                                          | tracktaste パラメータ |
| ---------------- | --------------------------------------------------- | --------------------- |
| `/jam track`     | URL / URI / ID → **URL に正規化**                   | `url`                 |
| `/jam artist`    | URL / URI / ID → **URL に正規化**                   | `url`                 |
| `/jam album`     | URL / URI / ID → **URL に正規化**                   | `url`                 |
| `/jam recommend` | URL / URI / ID → **URL に正規化**                   | `url`                 |
| `/jam search`    | 正規化不要（検索クエリをそのまま `q` パラメータへ） | `q`                   |

#### 入力バリデーション

以下の場合は「Spotify の URL / ID として認識できませんでした」エラーを返す:

- `open.spotify.com` 以外のドメインの URL
- URI 形式だが `spotify:` で始まらない
- 明らかに ID として不正な文字列（空文字、特殊文字のみ など）

#### エンティティ種別の検証

各コマンドは、対応するエンティティ種別のみを受け付ける:

- `/jam track` では track 用 URL / URI のみを受け付け、artist / album の URL / URI が指定された場合は「Spotify の TrackURL を入力してください」を返す
- `/jam artist` では artist 用 URL / URI のみを受け付ける
- `/jam album` では album 用 URL / URI のみを受け付ける
- `/jam recommend` では track 用 URL / URI のみを受け付ける

検証方法:

- URL の場合: パスの `/track/`, `/artist/`, `/album/` を確認
- URI の場合: 2 番目のセグメント（`spotify:track:xxx` の `track` 部分）を確認
- 生 ID の場合: エンティティ種別の検証は行わない（tracktaste 側で 404 が返る）

### 画像サイズ

Embed に表示する画像（アルバムアート、アーティスト画像）は、**最も大きい画像**を使用する。

### 欠損データの扱い

Spotify / tracktaste 側のデータが欠損している場合の表示方針:

| フィールド   | 欠損時の表示                       |
| ------------ | ---------------------------------- |
| ジャンル     | `ジャンル: なし` と表示            |
| 画像         | Embed のサムネイル画像は設定しない |
| フォロワー数 | `フォロワー: 0` と表示             |
| 人気度       | フィールド自体を Embed から省略    |

### レートリミット（アプリケーションレベル）

同一ユーザーが **10 秒間に 5 回以上** コマンドを実行した場合:

- `DeferReply()` を行わず、即座に `⏳ 少し待ってから再試行してください。` を **Ephemeral** で返す

実装方式:

- ユーザーごとに直近 10 秒間のコマンド実行回数をカウントする**簡易スライディングウィンドウ方式**とする
- 例: 1 秒おきに実行した場合、6 回目で制限がかかり、最初の実行から 10 秒経過後に解除される

---

## 機能一覧

### 1. トラック情報取得

Spotify のトラック URL から詳細情報を取得します。

| 項目     | 内容                                                  |
| -------- | ----------------------------------------------------- |
| コマンド | `/jam track <url>`                                    |
| 引数     | `url` - Spotify URL, URI, または ID（必須、位置引数） |

引数の説明（Discord 上で表示）: `Spotify の URL, URI, または ID を入力`

使用例:

- `/jam track https://open.spotify.com/track/xxx`
- `/jam track spotify:track:xxx`
- `/jam track 4iV5W9uYEdYUVa79Axb7Rh`

#### 応答項目

| フィールド      | 説明                                            |
| --------------- | ----------------------------------------------- |
| トラック名      | 曲名                                            |
| アーティスト名  | 全アーティスト（カンマ区切り）                  |
| アルバム名      | アルバム名                                      |
| 再生時間        | `M:SS` 形式                                     |
| リリース日      | Spotify の精度に応じた形式                      |
| Explicit フラグ | 明示的コンテンツの場合は 🔞 アイコン表示        |
| 人気度          | 0-100 のスコア（tracktaste の値をそのまま表示） |
| Spotify リンク  | トラックへの直接リンク                          |
| アルバムアート  | サムネイル画像（最大サイズ）                    |

#### Embed 構成例

```
┌─────────────────────────────────────────────────┐
│ 🎵 トラック名                                    │  ← Title
│ アーティストA, アーティストB                      │  ← Description
├─────────────────────────────────────────────────┤
│ アルバム      │ アルバム名                       │  ← Field (inline)
│ 再生時間      │ 3:45                            │  ← Field (inline)
│ リリース日    │ 2024-01-15                      │  ← Field (inline)
├─────────────────────────────────────────────────┤
│ 🔗 Spotify で開く                               │  ← URL (Author または Footer)
│                                    [アルバムアート] │  ← Thumbnail
└─────────────────────────────────────────────────┘
```

※ Explicit フラグがある場合は、タイトルに `🔞` を付与

---

### 2. レコメンド取得

Spotify のトラック URL を基に、関連するおすすめ楽曲を取得します。

| 項目     | 内容                                                  |
| -------- | ----------------------------------------------------- |
| コマンド | `/jam recommend <url>`                                |
| 引数     | `url` - Spotify URL, URI, または ID（必須、位置引数） |

引数の説明（Discord 上で表示）: `Spotify の URL, URI, または ID を入力`

使用例:

- `/jam recommend https://open.spotify.com/track/xxx`
- `/jam recommend spotify:track:xxx`
- `/jam recommend 4iV5W9uYEdYUVa79Axb7Rh`

#### 応答項目

| フィールド     | 説明                           |
| -------------- | ------------------------------ |
| トラック名     | 曲名                           |
| アーティスト名 | 全アーティスト（カンマ区切り） |
| アルバム名     | アルバム名                     |
| Spotify リンク | 各トラックへの直接リンク       |

> **注**: アーティスト名は `album.artists[]` から取得し、複数いる場合はカンマ区切りで連結して表示する。

#### 表示仕様

- tracktaste からは最大 30 件が返却される（popularity 降順でソート済み）
- 初回表示: 5 件
- ページング: 「◀ 前へ」「次へ ▶」ボタンで 5 件ずつページ送り（最大 6 ページ）
- tracktaste が返す順序をそのまま使用
- ページングデータはキャッシュに保存（30 日間有効）
- キャッシュ期限切れ時: Ephemeral で「データの有効期限が切れました。再度コマンドを実行してください。」と表示

#### Embed 構成例

```
┌─────────────────────────────────────────────────┐
│ 🎶 おすすめトラック                              │  ← Title
│ 「元トラック名」に基づくレコメンド (1-5 / 30 件)  │  ← Description
├─────────────────────────────────────────────────┤
│ 1. トラック名A - アーティストA                   │
│    📀 アルバム名A                                │
│    🔗 Spotify                                   │
│ 2. トラック名B - アーティストB                   │
│    📀 アルバム名B                                │
│    🔗 Spotify                                   │
│ 3. トラック名C - アーティストC                   │  ← Description 内にリスト
│    📀 アルバム名C                                │
│    🔗 Spotify                                   │
│ 4. トラック名D - アーティストD                   │
│    📀 アルバム名D                                │
│    🔗 Spotify                                   │
│ 5. トラック名E - アーティストE                   │
│    📀 アルバム名E                                │
│    🔗 Spotify                                   │
├─────────────────────────────────────────────────┤
│ [◀ 前へ]  [次へ ▶]  [👁 自分も見る]                 │  ← Button Components
└─────────────────────────────────────────────────┘
```

#### ページングボタンの動作

| ボタン             | 動作                                                                    |
| ------------------ | ----------------------------------------------------------------------- |
| ◀ 前へ             | 前の 5 件を表示（最初のページでは無効化）                               |
| 次へ ▶             | 次の 5 件を表示（最後のページでは無効化）                               |
| 👁 自分も見る       | 押したユーザー専用の Ephemeral Embed を表示（独立したページングが可能） |
| キャッシュ期限切れ | Ephemeral でエラーメッセージを表示                                      |

#### ボタンの操作権限

- **◀ 前へ / 次へ ▶**: コマンドを実行したユーザーのみが操作可能
  - 他のユーザーが押した場合は Ephemeral で「この操作はコマンド実行者のみが使用できます。『👁 自分も見る』ボタンを押すと、あなた専用の表示ができます。」と表示
- **👁 自分も見る**: 誰でも操作可能

#### 「👁 自分も見る」ボタンの動作

1. ボタンを押したユーザーに対して Ephemeral で同じ内容の Embed を表示
2. Ephemeral Embed には独立したページングボタン（◀ 前へ / 次へ ▶）が付く
3. Ephemeral 内のページングはそのユーザーのみが操作可能
4. 元のメッセージの状態には影響しない

---

### 3. アーティスト情報取得

Spotify のアーティスト URL から詳細情報を取得します。

| 項目     | 内容                                                  |
| -------- | ----------------------------------------------------- |
| コマンド | `/jam artist <url>`                                   |
| 引数     | `url` - Spotify URL, URI, または ID（必須、位置引数） |

引数の説明（Discord 上で表示）: `Spotify の URL, URI, または ID を入力`

使用例:

- `/jam artist https://open.spotify.com/artist/xxx`
- `/jam artist spotify:artist:xxx`
- `/jam artist 0OdUWJ0sBjDrqHygGUXeCF`

#### 応答項目

| フィールド       | 説明                                  |
| ---------------- | ------------------------------------- |
| アーティスト名   | 名前                                  |
| ジャンル         | 最大 3 件                             |
| フォロワー数     | tracktaste が返す文字列をそのまま表示 |
| 人気度           | 0-100 のスコア                        |
| アーティスト画像 | サムネイル画像（最大サイズ）          |
| Spotify リンク   | アーティストへの直接リンク            |

> ※ ジャンル・画像・人気度などが欠損している場合の挙動は「共通仕様 > 欠損データの扱い」に従う
> ※ tracktaste の artist/fetch レスポンスでは `followers` は文字列型で返される

#### Embed 構成例

```
┌─────────────────────────────────────────────────┐
│ 🎤 アーティスト名                                │  ← Title
├─────────────────────────────────────────────────┤
│ ジャンル       │ Pop, Rock, Indie               │  ← Field (inline)
│ フォロワー     │ 1,234,567                      │  ← Field (inline)
│ 人気度         │ 85                             │  ← Field (inline)
├─────────────────────────────────────────────────┤
│ 🔗 Spotify で開く                               │
│                                  [アーティスト画像] │  ← Thumbnail
└─────────────────────────────────────────────────┘
```

---

### 4. アルバム情報取得

Spotify のアルバム URL から詳細情報を取得します。

| 項目     | 内容                                                  |
| -------- | ----------------------------------------------------- |
| コマンド | `/jam album <url>`                                    |
| 引数     | `url` - Spotify URL, URI, または ID（必須、位置引数） |

引数の説明（Discord 上で表示）: `Spotify の URL, URI, または ID を入力`

使用例:

- `/jam album https://open.spotify.com/album/xxx`
- `/jam album spotify:album:xxx`
- `/jam album 4aawyAB9vmqN3uQ7FjRGTy`

#### 応答項目

| フィールド     | 説明                            |
| -------------- | ------------------------------- |
| アルバム名     | 名前                            |
| アーティスト名 | 全アーティスト（カンマ区切り）  |
| リリース日     | Spotify の精度に応じた形式      |
| トラック数     | 総曲数                          |
| 人気度         | 0-100 のスコア                  |
| トラック一覧   | 先頭 5 曲を番号付きリストで表示 |
| アルバムアート | サムネイル画像（最大サイズ）    |
| Spotify リンク | アルバムへの直接リンク          |

#### トラック一覧の表示形式

```
1. 曲名A
2. 曲名B
3. 曲名C
4. 曲名D
5. 曲名E
```

#### Embed 構成例

```
┌─────────────────────────────────────────────────┐
│ 💿 アルバム名                                    │  ← Title
│ アーティストA, アーティストB                      │  ← Description
├─────────────────────────────────────────────────┤
│ リリース日     │ 2024-01-15                      │  ← Field (inline)
│ トラック数     │ 12 曲                           │  ← Field (inline)
│ 人気度         │ 85                              │  ← Field (inline)
├─────────────────────────────────────────────────┤
│ 収録曲                                          │  ← Field
│ 1. 曲名A                                        │
│ 2. 曲名B                                        │
│ 3. 曲名C                                        │
│ 4. 曲名D                                        │
│ 5. 曲名E                                        │
├─────────────────────────────────────────────────┤
│ 🔗 Spotify で開く                               │
│                                    [アルバムアート] │  ← Thumbnail
└─────────────────────────────────────────────────┘
```

---

### 5. 検索

キーワードで Spotify のトラックを検索します。

| 項目     | 内容                                       |
| -------- | ------------------------------------------ |
| コマンド | `/jam search <query>`                      |
| 引数     | `query` - 検索キーワード（必須、位置引数） |

> **注**: 現在 tracktaste API はトラック検索のみ対応しているため、`/jam search` コマンドはトラック検索専用です。アーティスト検索・アルバム検索は tracktaste の将来対応に合わせて実装予定。

使用例:

- `/jam search 米津玄師`
- `/jam search Lemon 米津玄師`
- `/jam search Beatles Yesterday`

#### 応答項目

- トラック名
- アーティスト名
- アルバム名
- Spotify リンク

#### 表示仕様

- tracktaste からは最大 30 件が返却される
- 初回表示: 5 件
- ページング: 「◀ 前へ」「次へ ▶」ボタンで 5 件ずつページ送り（最大 6 ページ）
- 総件数が 0 件の場合は `🔍 該当する結果は見つかりませんでした。` を表示し、リストは出さない
- ページングデータはキャッシュに保存（30 日間有効）
- キャッシュ期限切れ時: Ephemeral で「データの有効期限が切れました。再度コマンドを実行してください。」と表示

#### Embed 構成例

```
┌─────────────────────────────────────────────────┐
│ 🔍 「検索キーワード」の検索結果                   │  ← Title
│ 1-5 件を表示                                     │  ← Description
├─────────────────────────────────────────────────┤
│ 1. トラック名A - アーティストA                   │
│    📀 アルバム名A                                │
│    🔗 Spotify                                   │
│ 2. トラック名B - アーティストB                   │
│    📀 アルバム名B                                │
│    🔗 Spotify                                   │
│ 3. トラック名C - アーティストC                   │  ← Description 内にリスト
│    📀 アルバム名C                                │
│    🔗 Spotify                                   │
│ 4. トラック名D - アーティストD                   │
│    📀 アルバム名D                                │
│    🔗 Spotify                                   │
│ 5. トラック名E - アーティストE                   │
│    📀 アルバム名E                                │
│    🔗 Spotify                                   │
├─────────────────────────────────────────────────┤
│ [◀ 前へ]  [次へ ▶]  [👁 自分も見る]                 │  ← Button Components
└─────────────────────────────────────────────────┘
```

#### ページングボタンの動作

| ボタン             | 動作                                                                    |
| ------------------ | ----------------------------------------------------------------------- |
| ◀ 前へ             | 前の 5 件を表示（最初のページでは無効化）                               |
| 次へ ▶             | 次の 5 件を表示（最後のページでは無効化）                               |
| 👁 自分も見る       | 押したユーザー専用の Ephemeral Embed を表示（独立したページングが可能） |
| キャッシュ期限切れ | Ephemeral でエラーメッセージを表示                                      |

#### ボタンの操作権限

- **◀ 前へ / 次へ ▶**: コマンドを実行したユーザーのみが操作可能
  - 他のユーザーが押した場合は Ephemeral で「この操作はコマンド実行者のみが使用できます。『👁 自分も見る』ボタンを押すと、あなた専用の表示ができます。」と表示
- **👁 自分も見る**: 誰でも操作可能

#### 「👁 自分も見る」ボタンの動作

1. ボタンを押したユーザーに対して Ephemeral で同じ内容の Embed を表示
2. Ephemeral Embed には独立したページングボタン（◀ 前へ / 次へ ▶）が付く
3. Ephemeral 内のページングはそのユーザーのみが操作可能
4. 元のメッセージの状態には影響しない

---

## キャッシュ

ページング機能のために、tracktaste からの検索結果・レコメンド結果をキャッシュに保存します。

### アーキテクチャ

2 層キャッシュ方式を採用:

```
┌─────────────────────────────────────────────────────────────────┐
│                         jamberry                                │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │   Handler   │────▶│   Service   │────▶│   Cache     │       │
│  │  (Discord)  │◀────│             │◀────│   Manager   │       │
│  └─────────────┘     └─────────────┘     └──────┬──────┘       │
│                                                  │              │
│                                    ┌─────────────┴─────────────┐│
│                                    │                           ││
│                               ┌────▼────┐              ┌───────▼───────┐
│                               │   L1    │              │      L2       │
│                               │ In-Mem  │              │    Redis      │
│                               │ (sync.  │              │               │
│                               │  Map)   │              │               │
│                               └─────────┘              └───────────────┘
└─────────────────────────────────────────────────────────────────┘
```

### キャッシュ層

| 層  | ストレージ            | 用途                       | TTL   |
| --- | --------------------- | -------------------------- | ----- |
| L1  | インメモリ (sync.Map) | 高速アクセス用             | 10 分 |
| L2  | Redis                 | 永続化・Bot 再起動後も保持 | 30 日 |

### キャッシュキー

```
pagination:{message_id}
```

### キャッシュ値

```json
{
  "command": "recommend | search",
  "query": "検索クエリ or トラックID",
  "type": "track | artist | album",
  "items": [...],
  "total": 123,
  "created_at": "2024-01-15T12:34:56Z"
}
```

### キャッシュフロー

#### 書き込み（コマンド実行時）

1. tracktaste から結果を取得
2. L1（インメモリ）に保存
3. L2（Redis）に保存
4. Discord にメッセージ送信（メッセージ ID を取得）
5. キャッシュキーをメッセージ ID で更新

#### 読み込み（ボタン押下時）

1. L1（インメモリ）を確認
   - ヒット → データを返す
   - ミス → 2 へ
2. L2（Redis）を確認
   - ヒット → L1 に書き戻してデータを返す
   - ミス → キャッシュ期限切れエラーを返す

### エラーハンドリング

| 状況               | 対応                                                                                 |
| ------------------ | ------------------------------------------------------------------------------------ |
| L1 ミス、L2 ヒット | L1 に書き戻してデータを返す                                                          |
| L1 ミス、L2 ミス   | Ephemeral で「データの有効期限が切れました。再度コマンドを実行してください。」と表示 |
| Redis 接続エラー   | L1 のみで動作を継続（ログ出力: WARN）                                                |

---

## tracktaste API インターフェース

### 基本設定

| 項目           | 値                                   |
| -------------- | ------------------------------------ |
| ベース URL     | 環境変数 `TRACKTASTE_API_URL` で指定 |
| API バージョン | v1                                   |
| URL 形式       | `{TRACKTASTE_API_URL}/v1/...`        |
| タイムアウト   | 5 秒                                 |
| Content-Type   | `application/json`                   |

### エンドポイント一覧

#### GET /v1/track/fetch

トラック情報を取得

```
GET /v1/track/fetch?url={spotify_url}
```

**レスポンス**:

```json
{
  "status": 200,
  "result": {
    "album": {
      "url": "string",
      "id": "string",
      "images": [{ "url": "string", "height": 640, "width": 640 }],
      "name": "string",
      "release_date": "string",
      "artists": [{ "url": "string", "name": "string", "id": "string" }]
    },
    "artists": [{ "url": "string", "id": "string", "name": "string" }],
    "disc_number": 1,
    "popularity": "int|null",
    "isrc": "string|null",
    "url": "string",
    "id": "string",
    "name": "string",
    "track_number": 1,
    "duration_ms": 123456,
    "explicit": true
  }
}
```

#### GET /v1/track/similar

類似トラック（レコメンド）を取得

```
GET /v1/track/similar?url={spotify_url}
```

**レスポンス**:

```json
{
  "status": 200,
  "result": {
    "items": [
      {
        "album": {
          "url": "string",
          "id": "string",
          "images": [{ "url": "string", "height": 640, "width": 640 }],
          "name": "string",
          "release_date": "string",
          "artists": [{ "url": "string", "name": "string", "id": "string" }]
        },
        "isrc": "string|null",
        "upc": "string|null",
        "url": "string",
        "id": "string",
        "name": "string",
        "popularity": "int|null",
        "track_number": 1,
        "duration_ms": 123456,
        "explicit": true
      }
    ]
  }
}
```

> **注**: 最大 30 件が返却される。ソート順は popularity 降順。

#### GET /v1/track/search

トラック検索を実行

```
GET /v1/track/search?q={query}
```

**レスポンス**:

```json
{
  "status": 200,
  "result": {
    "items": [
      {
        "album": {
          "url": "string",
          "id": "string",
          "images": [{ "url": "string", "height": 640, "width": 640 }],
          "name": "string",
          "release_date": "string",
          "artists": [{ "url": "string", "name": "string", "id": "string" }]
        },
        "artists": [{ "url": "string", "id": "string", "name": "string" }],
        "disc_number": 1,
        "popularity": "int|null",
        "isrc": "string|null",
        "url": "string",
        "id": "string",
        "name": "string",
        "track_number": 1,
        "duration_ms": 123456,
        "explicit": true
      }
    ]
  }
}
```

> **注**: tracktaste のトラック検索 API はトラックのみ対応。アーティスト検索・アルバム検索は将来対応予定。

#### GET /v1/artist/fetch

アーティスト情報を取得

```
GET /v1/artist/fetch?url={spotify_url}
```

**レスポンス**:

```json
{
  "status": 200,
  "result": {
    "url": "string",
    "followers": "string",
    "genres": ["string"],
    "id": "string",
    "images": [{ "url": "string", "height": 640, "width": 640 }],
    "name": "string",
    "popularity": "int|null"
  }
}
```

#### GET /v1/album/fetch

アルバム情報を取得

```
GET /v1/album/fetch?url={spotify_url}
```

**レスポンス**:

```json
{
  "status": 200,
  "result": {
    "url": "string",
    "id": "string",
    "images": [{ "url": "string", "height": 640, "width": 640 }],
    "name": "string",
    "release_date": "string",
    "artists": [{ "url": "string", "name": "string" }],
    "tracks": {
      "items": [
        {
          "artists": [{ "url": "string", "name": "string" }],
          "url": "string",
          "id": "string",
          "name": "string",
          "track_number": 1
        }
      ]
    },
    "popularity": 85,
    "upc": "string",
    "genres": ["string"]
  }
}
```

### エラーレスポンス

tracktaste は以下の形式でエラーを返す:

```json
{
  "status": 400,
  "message": "エラーメッセージ",
  "code": "ERROR_CODE"
}
```

### エラーコード一覧

| エラーコード              | 意味                         | jamberry の対応                                           |
| ------------------------- | ---------------------------- | --------------------------------------------------------- |
| `EMPTY_PARAM`             | パラメータが空               | Ephemeral で「URL を入力してください」と通知              |
| `EMPTY_URL`               | URL が入力されていない       | Ephemeral で「URL を入力してください」と通知              |
| `EMPTY_QUERY`             | 検索クエリが空               | Ephemeral で「検索キーワードを入力してください」と通知    |
| `INVALID_PARAM`           | パラメータが不正             | Ephemeral で「入力形式が不正です」と通知                  |
| `NOT_SPOTIFY_URL`         | Spotify 以外の URL           | Ephemeral で「Spotify の URL を入力してください」と通知   |
| `INVALID_URL`             | 不正な URL 形式              | Ephemeral で「Spotify の URL を入力してください」と通知   |
| `INVALID_RESOURCE_TYPE`   | 対象外のリソースタイプの URL | Ephemeral で「正しい種類の URL を入力してください」と通知 |
| `DIFFERENT_SPOTIFY_URL`   | 対象外のリソースタイプの URL | Ephemeral で「正しい種類の URL を入力してください」と通知 |
| `SOMETHING_SPOTIFY_ERROR` | Spotify API で問題発生       | 通常メッセージで「サーバーエラー」と通知、ERROR ログ出力  |
| `SOMETHING_KKBOX_ERROR`   | KKBOX API で問題発生         | 通常メッセージで「サーバーエラー」と通知、ERROR ログ出力  |
| `REQUEST_TIMEOUT`         | 処理がタイムアウト           | 通常メッセージで「タイムアウト」と通知、WARN ログ出力     |

### ステータスコードとハンドリング

| ステータス | 意味             | jamberry の対応                                    |
| ---------- | ---------------- | -------------------------------------------------- |
| 200        | 成功             | 正常にレスポンスを処理                             |
| 400        | 不正なリクエスト | エラーコードに応じたメッセージを通知               |
| 503        | サービス利用不可 | ユーザーに「サーバーエラー」と通知、ERROR ログ出力 |
| 504        | タイムアウト     | ユーザーに「タイムアウト」と通知、WARN ログ出力    |

### バージョン依存関係

- jamberry は tracktaste API v1 に依存する
- tracktaste の API 仕様に破壊的変更が行われた場合、jamberry のマイナーバージョンを更新し、エラーレポートで検知できるようにする

---

## エラーハンドリング

### エラー種別と対応

#### ユーザー起因エラー（即時判定・Ephemeral）

`DeferReply()` を行わず、即座に Ephemeral で返信:

| エラー                               | メッセージ例                                          | ログレベル |
| ------------------------------------ | ----------------------------------------------------- | ---------- |
| 無効な URL/ID                        | `❌ Spotify の URL / ID として認識できませんでした。` | INFO       |
| エンティティ種別不一致               | `❌ Spotify の URL / ID として認識できませんでした。` | INFO       |
| アプリケーションレベルレートリミット | `⏳ 少し待ってから再試行してください。`               | WARN       |

#### ユーザー起因エラー（tracktaste 経由・通常メッセージ）

`DeferReply()` 後に `EditOriginalInteractionResponse` で返信（チャンネル全体に表示）:

| エラー                 | メッセージ例                                  | ログレベル |
| ---------------------- | --------------------------------------------- | ---------- |
| リソースが見つからない | `❌ 指定された{対象}が見つかりませんでした。` | INFO       |
| 非公開/削除済み        | `❌ このコンテンツは利用できません。`         | INFO       |

> **注**: 各コマンドに応じて、「{対象}」部分を「トラック / アーティスト / アルバム」に置き換えて表示する

#### サーバー起因エラー（通常メッセージ）

`DeferReply()` 後に `EditOriginalInteractionResponse` で返信（チャンネル全体に表示）:

| エラー                  | メッセージ例                                                                | ログレベル |
| ----------------------- | --------------------------------------------------------------------------- | ---------- |
| tracktaste 5xx          | `❌ サーバーエラーが発生しました。しばらくしてから再試行してください。`     | ERROR      |
| tracktaste タイムアウト | `❌ リクエストがタイムアウトしました。しばらくしてから再試行してください。` | WARN       |
| ネットワークエラー      | `❌ 接続エラーが発生しました。`                                             | ERROR      |

#### 外部起因エラー

| エラー                    | メッセージ例                                                    | 可視性         | ログレベル |
| ------------------------- | --------------------------------------------------------------- | -------------- | ---------- |
| tracktaste レートリミット | `⏳ リクエスト制限中です。しばらくしてから再試行してください。` | 通常メッセージ | WARN       |
| Discord レートリミット    | discordgo が自動ハンドリング                                    | -              | -          |

### レートリミット方針

- **tracktaste 側**: jamberry 側での事前制御は行わない。429 レスポンスをそのままユーザーに通知。
- **Discord 側**: discordgo のビルトイン機能に委任。
- **アプリケーション側**: 同一ユーザーが 10 秒間に 5 回以上コマンドを実行した場合、簡易レート制限を適用（Ephemeral で通知）。

---

## 環境変数

| 変数名               | 説明                                             | 必須             |
| -------------------- | ------------------------------------------------ | ---------------- |
| `DISCORD_BOT_TOKEN`  | Discord Bot のトークン                           | ✅               |
| `TRACKTASTE_API_URL` | tracktaste API のベース URL (`/v1` は含まない)   | ✅               |
| `REDIS_URL`          | Redis の接続 URL（例: `redis://localhost:6379`） | ✅               |
| `LOG_LEVEL`          | ログレベル (DEBUG / INFO / WARN / ERROR)         | デフォルト: INFO |

---

## 非機能要件

### ログ

#### リクエストログ

- ギルド ID
- チャンネル ID
- コマンド名
- 実行時刻

#### tracktaste 通信ログ

- リクエスト URL
- ステータスコード
- レイテンシ (ms)

#### エラーログ

エラー発生時は以下の情報を出力:

- エラー種別（ユーザー起因 / 5xx / Timeout など）
- tracktaste のステータスコード
- リクエストコンテキスト（ギルド ID、チャンネル ID、コマンド名）

#### ログ共通設定

| 項目           | 設定値                                      |
| -------------- | ------------------------------------------- |
| タイムゾーン   | UTC                                         |
| タイムスタンプ | ISO 8601 形式（例: `2024-01-15T12:34:56Z`） |

#### ログとプライバシー

- Discord ユーザー ID はログに出力する可能性がある
- ログの保存期間: 30 日間
- 用途: エラー調査、利用状況の把握のみ

### メトリクス（将来対応）

- コマンド別呼び出し回数
- tracktaste 呼び出しレイテンシ
- エラー率

### デプロイ

| 項目              | 仕様                                                                                      |
| ----------------- | ----------------------------------------------------------------------------------------- |
| 実行形態          | 単一コンテナ (Docker)                                                                     |
| ポート            | 不要（アウトバウンド通信のみ）                                                            |
| 外部依存          | Redis（ページングキャッシュ用）                                                           |
| ヘルスチェック    | なし（将来的に HTTP エンドポイント追加を検討）                                            |
| Graceful Shutdown | SIGINT / SIGTERM を受けて Discord セッションを Close し、未完了リクエストをキャンセルする |

---

## 今後の拡張予定

### プレイリスト情報取得機能

- URL から情報を取得して表示するのみ
- プレイリスト内の曲をレコメンドや検索とつなげる機能は将来検討

### お気に入り登録機能 / 再生履歴機能

> 将来的にユーザー固有のデータ（お気に入り・履歴）を保存する可能性があるため、Discord ユーザー ID を主キーとして扱うストレージを別途導入する想定。

- Spotify アカウントとの OAuth 連携は現時点では行わない
- データストアは PostgreSQL または SQLite を検討

---

## 関連ドキュメント

| ドキュメント                         | 説明                                           |
| ------------------------------------ | ---------------------------------------------- |
| [ARCHITECTURE.md](./ARCHITECTURE.md) | アーキテクチャ設計（レイヤー構成、依存関係）   |
| [USECASE.md](./USECASE.md)           | ユースケース仕様（ユーザーストーリー、フロー） |
| [TEST_SPEC.md](./TEST_SPEC.md)       | テスト仕様（テストケース、カバレッジ目標）     |
